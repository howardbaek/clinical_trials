tidytext Anaylsis
================
Jason Baik
12/2/2018

Load libraries and connect to PostgreSQL database
-------------------------------------------------

``` r
library(tidyverse)
```

    ## ── Attaching packages ─────── tidyverse 1.2.1 ──

    ## ✔ ggplot2 3.1.0     ✔ purrr   0.2.5
    ## ✔ tibble  1.4.2     ✔ dplyr   0.7.8
    ## ✔ tidyr   0.8.2     ✔ stringr 1.3.1
    ## ✔ readr   1.2.1     ✔ forcats 0.3.0

    ## ── Conflicts ────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()

``` r
library(tidytext)
library(topicmodels)
library(RPostgreSQL)
```

    ## Loading required package: DBI

``` r
library(DBI)
library(broom)
theme_set(theme_light())


drv <- dbDriver('PostgreSQL')
con <- dbConnect(drv, 
                 dbname="aact",
                 host="aact-db.ctti-clinicaltrials.org", 
                 port=5432,
                 user=readr::read_csv("id_pw.csv")$id, 
                 password=readr::read_csv("id_pw.csv")$pw
                 )
```

    ## Parsed with column specification:
    ## cols(
    ##   id = col_character(),
    ##   pw = col_character()
    ## )

    ## Parsed with column specification:
    ## cols(
    ##   id = col_character(),
    ##   pw = col_character()
    ## )

``` r
dbTables <- dbListTables(con)
```

Notes about AACT
----------------

The AACT database is updated every night at midnight, so the information in AACT is one day behind that which appears in ClinicalTrials.gov

Tables with `MeSH terms` as a variable: intervention\_browse, condition\_browse, mesh\_thesaurus.

In ClinicalTrials.gov, each trial has keywords that describe the trial. The ClinicalTrials.gov team assigns each trial two sets of MeSH terms. One set for the conditions studied by the trial and another for the set of interventions used in the trial. The XML file that can be downloaded for each trial contains these MeSH keywords. The XML file also has a comment that says: "the assignment of MeSH keywords is done by imperfect algorithm".

When data submitters provide information to ClinicalTrials.gov about a study, they’re encouraged to use Medical Subject Heading (MeSH) terminology for interventions, conditions, and keywords. The Browse\_Conditions and Browse\_Interventions tables contain MeSH terms generated by an algorithm run by NLM. The NLM algorithm is re-run nightly on all studies in the ClinicalTrials.gov database, and sources the most up-to-date information in the study record, the latest version of the algorithm, and the version of the MeSH thesaurus in use at that time.

Explore MeSH terms in browse\_conditions table
----------------------------------------------

``` r
# browse_conditions
browse_conditions <- tbl(con, "browse_conditions") %>% 
  collect()
```

There are duplicate nct\_ids, but when you count by nct\_id and mesh\_term, there are NO duplicates.

### Explore mesh\_term inside browse\_conditions

``` r
browse_conditions %>% 
  count(mesh_term, sort = TRUE) %>% 
  head(20) %>% 
  mutate(mesh_term = fct_reorder(mesh_term, n)) %>% 
  ggplot(aes(mesh_term, n, fill = mesh_term)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  labs(x = "MeSH Terms", y = "Counts") +
  ggtitle("Top 20 Most Occuring MeSH Terms in Conditions Table")
```

![](tidytext-analysis_files/figure-markdown_github/unnamed-chunk-3-1.png)

LDA on mesh\_term
-----------------

<https://www.tidytextmining.com/>

Followed this tutorial by David Robinson and Julia Siege: <https://cran.r-project.org/web/packages/tidytext/vignettes/topic_modeling.html>

``` r
# Create counts dataset
mesh_term_counts <- browse_conditions %>% 
  count(nct_id, mesh_term, sort = TRUE) %>% 
  ungroup() 

# Get Document Term Matrix using cast_dtm
condition_dtm <- mesh_term_counts %>% 
  cast_dtm(nct_id, mesh_term, n)

# Use topicmodels package to create a four topic LDA model
topic_lda <- topicmodels::LDA(condition_dtm, k = 4, control = list(seed = 1234))

topic_lda_td <- tidy(topic_lda)

# Spread 
topic_lda_td %>% 
  spread(topic, beta) %>% 
  arrange(desc(`1`))
```

    ## # A tibble: 3,892 x 5
    ##    term                         `1`      `2`      `3`      `4`
    ##    <chr>                      <dbl>    <dbl>    <dbl>    <dbl>
    ##  1 Diabetes Mellitus, Type 2 0.0270 0.00821  0.00182  0.00548 
    ##  2 Diabetes Mellitus         0.0222 0.0108   0.00844  0.0263  
    ##  3 Syndrome                  0.0162 0.00114  0.0282   0.00231 
    ##  4 Hepatitis                 0.0137 0.000317 0.00223  0.00543 
    ##  5 Sclerosis                 0.0132 0.000838 0.000166 0.00228 
    ##  6 Myocardial Ischemia       0.0119 0.0130   0.000651 0.00248 
    ##  7 HIV Infections            0.0108 0.000604 0.0168   0.00620 
    ##  8 Coronary Disease          0.0104 0.0141   0.00142  0.00116 
    ##  9 Hepatitis C               0.0103 0.00110  0.00286  0.000981
    ## 10 Multiple Sclerosis        0.0100 0.00106  0.00153  0.000896
    ## # ... with 3,882 more rows

``` r
# Lymphoma is closely associated with Topic 1 and not much with other three topics.

# Find top 5 terms within each topic:
top_mesh_terms <- topic_lda_td %>% 
  group_by(topic) %>% 
  top_n(5, beta) %>% 
  ungroup() %>% 
  arrange(topic, -beta)
```

``` r
top_mesh_terms %>%
  mutate(term = reorder(term, beta)) %>% 
  mutate(topic = case_when(
    topic == 1 ~ "#1",
    topic == 2 ~ "#2",
    topic == 3 ~ "#3",
    topic == 4 ~ "#4",
    TRUE ~ "NA Topic"
  )) %>% 
  ggplot(aes(term, beta, fill = term)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "MeSH",
       y = "Beta (Probability of MeSH being generated from topic)") +
  ggtitle("Distribution of MeSH for 4 Topics from LDA")
```

![](tidytext-analysis_files/figure-markdown_github/unnamed-chunk-5-1.png)
